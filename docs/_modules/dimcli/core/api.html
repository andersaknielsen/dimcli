

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>dimcli.core.api &mdash; DimCli  documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> DimCli
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">Dimcli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidocs.html">Api Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">DimCli</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>dimcli.core.api</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for dimcli.core.api</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">api.py</span>
<span class="sd">====================================</span>
<span class="sd">The core module of DimCli</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">IPython.display</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">islice</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">.auth</span> <span class="k">import</span> <span class="n">do_global_login</span><span class="p">,</span> <span class="n">get_connection</span><span class="p">,</span> <span class="n">refresh_login</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.walkup</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.dsl_grammar</span> <span class="k">import</span> <span class="n">G</span>
<span class="kn">from</span> <span class="nn">.dataframe_factory</span> <span class="k">import</span> <span class="n">DfFactory</span>




<div class="viewcode-block" id="Dsl"><a class="viewcode-back" href="../../../apidocs.html#dimcli.core.api.Dsl">[docs]</a><span class="k">class</span> <span class="nc">Dsl</span><span class="p">():</span>

    <span class="sd">&quot;&quot;&quot;The Dsl object is the main interface for interacting with the Dimensions API.</span>
<span class="sd"> </span>
<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    After logging in, the usual workflow is to instantiate this object and use it to query. </span>

<span class="sd">        &gt;&gt;&gt; import dimcli</span>
<span class="sd">        &gt;&gt;&gt; dimcli.login()</span>
<span class="sd">        &gt;&gt;&gt; dsl = dimcli.Dsl()</span>
<span class="sd">        &gt;&gt;&gt; dsl.query(&quot;search grants for \&quot;malaria\&quot; return researchers&quot;)</span>
<span class="sd">        &gt;&gt;&gt; &lt;dimcli.dimensions.DslDataset object&gt;</span>
<span class="sd">        # queries always return a DslDataset object (subclassing IPython.display.JSON)</span>
<span class="sd">        # use the .json method to get the JSON</span>
<span class="sd">        &gt;&gt;&gt; _.json</span>
<span class="sd">        &gt;&gt;&gt; {&#39;researchers&#39;: [{&#39;id&#39;: &#39;ur.01332073522.49&#39;,</span>
<span class="sd">                &#39;count&#39;: 75,</span>
<span class="sd">                &#39;last_name&#39;: &#39;White&#39;,</span>
<span class="sd">                &#39;first_name&#39;: &#39;Nicholas J&#39;},</span>
<span class="sd">            &quot;... JSON data continues ... &quot;</span>


<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Dsl.__init__"><a class="viewcode-back" href="../../../apidocs.html#dimcli.core.api.Dsl.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_results</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialises a Dsl object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        show_results : bool</span>
<span class="sd">            Set a global setting that determined whether query JSON results get printed out. Note that in Jupyter environments this is not needed, because the iPython rich widgets is used by default.</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            Verbose mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_results</span> <span class="o">=</span> <span class="n">show_results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_CONNECTION</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONNECTION</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]:</span>
            <span class="c1"># if already logged in, reuse connection          </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONNECTION</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="s2">&quot;JWT &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONNECTION</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_please_login</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_logged_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="ow">and</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_print_please_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: you are not logged in. Please use `dimcli.login(username, password)` before querying.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Dsl.query"><a class="viewcode-back" href="../../../apidocs.html#dimcli.core.api.Dsl.query">[docs]</a>    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">show_results</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute a single DSL query.</span>

<span class="sd">        By default it doesn&#39;t show results, but it uses the iPython rich widgets for it, optimized for Jupyter Notebooks.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        show_results : bool</span>
<span class="sd">            Show JSON results.</span>
<span class="sd">        retry : int</span>
<span class="sd">            Number of times to retry the query if it fails.</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            Verbose mode.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DslDataset</span>
<span class="sd">            A Dimcli wrapper object containing JSON data. </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_logged_in</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_please_login</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span>

        <span class="c1">#   Execute DSL query.</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/api/dsl.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">q</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">429</span><span class="p">:</span>  
            <span class="c1"># Too Many Requests</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;Too Many Requests for the Server. Sleeping for 30 seconds and then retrying.&#39;</span>
            <span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">show_results</span><span class="p">,</span> <span class="n">retry</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>  
            <span class="c1"># Forbidden:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Login token expired. Logging in again.&#39;</span><span class="p">)</span>
            <span class="n">refresh_login</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_CONNECTION</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONNECTION</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="s2">&quot;JWT &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONNECTION</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]}</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">show_results</span><span class="p">,</span> <span class="n">retry</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">500</span><span class="p">]:</span>  
            <span class="c1">###  </span>
            <span class="c1"># OK or Error Info :-)</span>
            <span class="c1">###</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res_json</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unexpected error. JSON could not be parsed.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">DslDataset</span><span class="p">(</span><span class="n">res_json</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">print_json_stats</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
            <span class="n">print_json_errors</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="c1"># ALWAYS print errors</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">print_json_warnings</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show_results</span> <span class="ow">or</span> <span class="p">(</span><span class="n">show_results</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_show_results</span><span class="p">):</span>
                <span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">retry</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Retrying in 30 secs&#39;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                    <span class="n">q</span><span class="p">,</span>
                    <span class="n">show_results</span><span class="p">,</span>
                    <span class="n">retry</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> 
                    <span class="n">verbose</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span></div>



<div class="viewcode-block" id="Dsl.query_iterative"><a class="viewcode-back" href="../../../apidocs.html#dimcli.core.api.Dsl.query_iterative">[docs]</a>    <span class="k">def</span> <span class="nf">query_iterative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">show_results</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pause</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tot_count_prev_query</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>       
        <span class="sd">&quot;&quot;&quot;Runs a DSL query and then keep querying until all available records are extracted. </span>
<span class="sd">        </span>
<span class="sd">        Iterative DSL queries work by automatically paginating through all records available for a result set. The original query gets turned into a loop that uses the `limit` / `skip` operators until all the results available have been extracted. </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        q: str </span>
<span class="sd">            The DSL query. Important: pagination keywords eg `limit` / `skip` should be omitted.</span>
<span class="sd">        show_results : bool</span>
<span class="sd">            Determines whether the final results are rendered via the iPython display widget (for Jupyter notebooks).</span>
<span class="sd">        limit : int</span>
<span class="sd">            How many records to extract per iteration. Defaults to 1000.</span>
<span class="sd">        skip : int</span>
<span class="sd">            Offset for first iteration. Defaults to 0. After the first iteration, this value is calculated dynamically.</span>
<span class="sd">        pause : float</span>
<span class="sd">            How much time to pause after each iterarion, expressed in seconds. Defaults to 1.5. Note: each iteration gets timed, so the pause time is used only when the query time is more than 2s. </span>
<span class="sd">        verbose : bool</span>
<span class="sd">            Verbose mode.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DslDataset</span>
<span class="sd">            A Dimcli wrapper object containing JSON data. </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_logged_in</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_please_login</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span>

        <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;return&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Iterative queries support only 1 return statement&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line_has_limit_or_skip</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Iterative queries should not contain the keywords `limit` or `skip`&quot;</span><span class="p">)</span>
        <span class="n">sourcetype</span> <span class="o">=</span> <span class="n">line_search_return</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>  
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">sourcetype</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">sources</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Iterative queries can return only one of the Dimensions sources: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">sources</span><span class="p">()]))</span> 
        <span class="c1">#</span>
        <span class="c1"># ensure we stop the loop at 50k **</span>
        <span class="c1">#</span>
        <span class="n">MAXLIMIT</span> <span class="o">=</span> <span class="mi">50000</span>
        <span class="n">flag_last_round</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">skip</span> <span class="o">+</span> <span class="n">limit</span> <span class="o">&gt;=</span> <span class="n">MAXLIMIT</span><span class="p">:</span>
            <span class="n">flag_last_round</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">skip</span> <span class="o">+</span> <span class="n">limit</span> <span class="o">&gt;</span> <span class="n">MAXLIMIT</span><span class="p">:</span>
                <span class="n">limit</span> <span class="o">=</span> <span class="n">MAXLIMIT</span> <span class="o">-</span> <span class="n">skip</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="n">tot_count_prev_query</span><span class="p">:</span>
            <span class="c1"># first iteration</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;{limit+skip} / ...&quot;</span><span class="p">)</span>
            
        <span class="n">output</span><span class="p">,</span> <span class="n">flag_force</span> <span class="o">=</span> <span class="p">[],</span> <span class="kc">False</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="s2">&quot; limit </span><span class="si">%d</span><span class="s2"> skip </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">skip</span><span class="p">)</span>
        
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">q2</span><span class="p">,</span> <span class="n">show_results</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># print(end - start)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># print(&quot;sleeping&quot;)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">pause</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&gt;&gt;&gt;[Dimcli tip] An error occurred with the batch &#39;</span><span class="si">{skip}</span><span class="s2">-{limit+skip}&#39;. Consider using the &#39;limit&#39; argument to retrieve fewer records per iteration, or use &#39;force=True&#39; to ignore errors and continue the extraction.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">elif</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">force</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&gt;&gt;&gt;[Dimcli log] An error occurred with the batch &#39;</span><span class="si">{skip}</span><span class="s2">-{limit+skip}&#39;. Skipping this batch and continuing iteration.. &quot;</span><span class="p">)</span>
            <span class="n">flag_force</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># RECURSION </span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">tot</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;stats&#39;</span><span class="p">][</span><span class="s1">&#39;total_count&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">tot</span> <span class="o">=</span>  <span class="n">tot_count_prev_query</span> <span class="c1"># when force=True, we have no current query stats</span>

        <span class="n">new_skip</span> <span class="o">=</span> <span class="n">skip</span><span class="o">+</span><span class="n">limit</span>
        <span class="k">if</span> <span class="n">tot</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">new_skip</span> <span class="o">&gt;</span> <span class="n">tot</span><span class="p">:</span>
            <span class="n">new_skip</span> <span class="o">=</span> <span class="n">tot</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">tot</span><span class="p">:</span>  <span class="c1"># if not first iteration</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{new_skip}</span><span class="s2"> / </span><span class="si">{tot}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">flag_force</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_iterative</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">show_results</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">new_skip</span><span class="p">,</span> <span class="n">pause</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">tot_count_prev_query</span><span class="p">)</span>                    

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">sourcetype</span><span class="p">])</span> <span class="o">==</span> <span class="n">limit</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">flag_last_round</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">sourcetype</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_iterative</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">show_results</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">new_skip</span><span class="p">,</span> <span class="n">pause</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">tot</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">sourcetype</span><span class="p">]</span>

        <span class="c1"># FINALLY </span>
        <span class="c1">#</span>
        <span class="c1"># if recursion is complete (we are at top level, hence skip=0) </span>
        <span class="c1">#   build the DslDataset obj</span>
        <span class="c1"># else </span>
        <span class="c1">#   just return current iteration results </span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">skip</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
            <span class="n">response_simulation</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;_stats&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;total_count&quot;</span><span class="p">:</span> <span class="n">tot</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>  <span class="c1"># fallback..</span>
                    <span class="p">},</span>
                <span class="n">sourcetype</span><span class="p">:</span> <span class="n">output</span>
            <span class="p">}</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">DslDataset</span><span class="p">(</span><span class="n">response_simulation</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show_results</span> <span class="ow">or</span> <span class="p">(</span><span class="n">show_results</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_show_results</span><span class="p">):</span>
                <span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;===</span><span class="se">\n</span><span class="s2">Records extracted: {len(output)}&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span></div>


    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;&lt;dimcli.Dsl #{id(self)}. API endpoint: </span><span class="si">{self._url}</span><span class="s2">&gt;&quot;</span></div>



        

<div class="viewcode-block" id="DslDataset"><a class="viewcode-back" href="../../../apidocs.html#dimcli.core.api.DslDataset">[docs]</a><span class="k">class</span> <span class="nc">DslDataset</span><span class="p">(</span><span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">JSON</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper for JSON results from DSL.</span>

<span class="sd">    Example</span>
<span class="sd">    ----------</span>

<span class="sd">        &gt;&gt;&gt; res = dsl.query(&quot;search publications return publications&quot;)</span>
<span class="sd">        &gt;&gt;&gt; res.data # =&gt; shows the underlying JSON data</span>
<span class="sd">        &gt;&gt;&gt; res.json # =&gt; same </span>

<span class="sd">        # Shortcuts methods: </span>

<span class="sd">        &gt;&gt;&gt; res[&#39;publications&#39;] # =&gt; the dict section</span>
<span class="sd">        &gt;&gt;&gt; res[&#39;xxx&#39;] # =&gt; false, not found</span>
<span class="sd">        &gt;&gt;&gt; res[&#39;stats&#39;] # =&gt; the _stats dict</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># class methods to build DslDataset object from raw data (obtained not from a query eg from multiple queries concatenated)</span>
    <span class="c1"># these allow to then take advantage of other functionalities in DslDataset objects eg dataframes etc...</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_publications_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_any_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;publications&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_grants_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_any_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;grants&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_researchers_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_any_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;researchers&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_clinical_trials_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_any_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;clinical_trials&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_patents_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_any_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;patents&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_policy_documents_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_any_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;policy_documents&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_organizations_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_any_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;organizations&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="DslDataset.from_any_list"><a class="viewcode-back" href="../../../apidocs.html#dimcli.core.api.DslDataset.from_any_list">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_any_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">source_type</span><span class="p">):</span>
        <span class="s2">&quot;Generic method used by all the ones above&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">({</span><span class="n">source_type</span> <span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;_stats&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;total_count&#39;</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)}})</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
            <span class="n">jsondata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">({</span><span class="n">source_type</span> <span class="p">:</span> <span class="n">jsondata</span><span class="p">,</span> <span class="s1">&#39;_stats&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;total_count&#39;</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">jsondata</span><span class="p">)}})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid data format. Must be either a dict list, or a pandas dataframe&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="DslDataset.__init__"><a class="viewcode-back" href="../../../apidocs.html#dimcli.core.api.DslDataset.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">JSON</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c1"># add result dict keys as attributes dynamically</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;_stats&quot;</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;stats&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_factory</span> <span class="o">=</span> <span class="n">DfFactory</span><span class="p">(</span><span class="n">good_data_keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_data_keys</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="s2">&quot;Trick to return any dict key as a property&quot;</span>
        <span class="c1"># print(key, &quot;==========&quot;)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;stats&quot;</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;_stats&quot;</span> <span class="c1"># syntactic sugar</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span> <span class="c1"># empty list so to support iteration tests / previously: False</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Return length of first object in JSON (skipping &#39;_stats&#39;&quot;</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_data_keys</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

<div class="viewcode-block" id="DslDataset.good_data_keys"><a class="viewcode-back" href="../../../apidocs.html#dimcli.core.api.DslDataset.good_data_keys">[docs]</a>    <span class="k">def</span> <span class="nf">good_data_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
        <span class="s2">&quot;return the results keys other than stats&quot;</span>
        <span class="n">skips</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_warnings&quot;</span><span class="p">,</span> <span class="s2">&quot;_notes&quot;</span><span class="p">,</span> <span class="s2">&quot;_stats&quot;</span><span class="p">,</span> <span class="s2">&quot;_version&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skips</span><span class="p">]</span></div>

<div class="viewcode-block" id="DslDataset.keys_and_count"><a class="viewcode-back" href="../../../apidocs.html#dimcli.core.api.DslDataset.keys_and_count">[docs]</a>    <span class="k">def</span> <span class="nf">keys_and_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
        <span class="s2">&quot;Utility to preview contents of results object&quot;</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">count_total</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
        <span class="s2">&quot;Quickly return tot count for query (not for current payload)&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_stats&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;_stats&#39;</span><span class="p">][</span><span class="s1">&#39;total_count&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">count_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
        <span class="s2">&quot;Quickly return tot count for current batch from query&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">errors_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>  <span class="c1"># can&#39;t be called &#39;error&#39; due to conflict with auto-set field</span>
        <span class="s2">&quot;Quickly return errors string&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">][</span><span class="s1">&#39;query&#39;</span><span class="p">][</span><span class="s1">&#39;header&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">][</span><span class="s1">&#39;query&#39;</span><span class="p">][</span><span class="s1">&#39;details&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

<div class="viewcode-block" id="DslDataset.chunks"><a class="viewcode-back" href="../../../apidocs.html#dimcli.core.api.DslDataset.chunks">[docs]</a>    <span class="k">def</span> <span class="nf">chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an iterator for going through chunks of the JSON results. </span>
<span class="sd">        NB the first available dict key is taken, to determine what is the data </span>
<span class="sd">        object being returned. </span>
<span class="sd">        Default size of chunks = 400 elements</span>

<span class="sd">        EG</span>

<span class="sd">        res = dslquery(&quot;search publications return publications limit 1000&quot;)</span>
<span class="sd">        test = [len(x) for x in res.chunks()]</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_data_keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Please specify a key from {self.good_data_keys()}&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_data_keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_data_keys</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Invalid key: should be one of {self.good_data_keys()}&quot;</span><span class="p">)</span>
            <span class="k">return</span> 

        <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
        <span class="k">while</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">chunk</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span></div>

    <span class="c1"># Dataframe Methods </span>

<div class="viewcode-block" id="DslDataset.as_dataframe"><a class="viewcode-back" href="../../../apidocs.html#dimcli.core.api.DslDataset.as_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">as_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="s2">&quot;utility method: return inner json as a pandas dataframe&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_factory</span><span class="o">.</span><span class="n">df_simple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span></div>


<div class="viewcode-block" id="DslDataset.as_dataframe_authors"><a class="viewcode-back" href="../../../apidocs.html#dimcli.core.api.DslDataset.as_dataframe_authors">[docs]</a>    <span class="k">def</span> <span class="nf">as_dataframe_authors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Utility method: return inner json as a pandas dataframe, exposing authors + pubId</span>
<span class="sd">            Note: affiliations are not broken down. So one gets one row per author</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_factory</span><span class="o">.</span><span class="n">df_authors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">)</span></div>


<div class="viewcode-block" id="DslDataset.as_dataframe_authors_affiliations"><a class="viewcode-back" href="../../../apidocs.html#dimcli.core.api.DslDataset.as_dataframe_authors_affiliations">[docs]</a>    <span class="k">def</span> <span class="nf">as_dataframe_authors_affiliations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Utility method: return inner json as a pandas dataframe, exposing authors + affiliations + pubId</span>
<span class="sd">        Affiliations ARE broken down and are returned as JSON - So one gets one row per affiliation (+1 row per author if having more than one affiliation)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_factory</span><span class="o">.</span><span class="n">df_authors_affiliations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">)</span></div>

<div class="viewcode-block" id="DslDataset.as_dataframe_concepts"><a class="viewcode-back" href="../../../apidocs.html#dimcli.core.api.DslDataset.as_dataframe_concepts">[docs]</a>    <span class="k">def</span> <span class="nf">as_dataframe_concepts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Utility method: return inner concepts list as a pandas dataframe, including several metrics for working with concepts.</span>

<span class="sd">        :param key: the JSON data key including concept information. If key is empty, the first available JSON key (eg &#39;publications&#39;) is used to build the dataframe</span>

<span class="sd">        The resulting dataframe has extra columns for ranking concepts:</span>
<span class="sd">        1) `concepts_count`: an integer representing the total number of concepts per document.</span>
<span class="sd">        2) `rank`: an integer representing the ranking of the concept within the list of concepts for a single document. E.g., the first concept has rank=1, while the fifth has rank=5.</span>
<span class="sd">        3) `score`: a float representing the importance of the concept in within a document. This is obtained by  normalizing its ranking against the total number of concepts for a single document (eg publication or grant). So if a document has 10 concepts in total, the first concept gets a score=1, the second score=0.9, etc..</span>
<span class="sd">        4) `frequency`: an integer representing how often that concept occurs within the full results-set returned by a query, i.e. how many documents have that concept name. So if a concept appears in 5 documents, frequency=5.</span>
<span class="sd">        5) `rank_avg`: the average (mean) value of all ranks for a single concept, across the full set of documents returned by the query. </span>
<span class="sd">        6) `score_avg`: the average (mean) value of all scores for a single concept, across the full set of documents returned by a query.  </span>
<span class="sd">        7) `score_sum`: the sum of all scores for a single concept, across the full set of documents returned by a query.  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_factory</span><span class="o">.</span><span class="n">df_concepts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span></div>


<div class="viewcode-block" id="DslDataset.as_dataframe_funders"><a class="viewcode-back" href="../../../apidocs.html#dimcli.core.api.DslDataset.as_dataframe_funders">[docs]</a>    <span class="k">def</span> <span class="nf">as_dataframe_funders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Utility method: return inner json as a pandas dataframe, for grants funders</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_factory</span><span class="o">.</span><span class="n">df_grant_funders</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">)</span></div>

<div class="viewcode-block" id="DslDataset.as_dataframe_investigators"><a class="viewcode-back" href="../../../apidocs.html#dimcli.core.api.DslDataset.as_dataframe_investigators">[docs]</a>    <span class="k">def</span> <span class="nf">as_dataframe_investigators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Utility method: return inner json as a pandas dataframe, for grants funders</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_factory</span><span class="o">.</span><span class="n">df_grant_investigators</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">)</span></div>

<div class="viewcode-block" id="DslDataset.as_dimensions_url"><a class="viewcode-back" href="../../../apidocs.html#dimcli.core.api.DslDataset.as_dimensions_url">[docs]</a>    <span class="k">def</span> <span class="nf">as_dimensions_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates a valid Dimensions search URL using all the object IDs as filters.</span>
<span class="sd">        NOTE: this is EXPERIMENTAL and may break or be removed in future versions. </span>
<span class="sd">        Also, doesn&#39;t work with all sources. </span>

<span class="sd">        &lt;max&gt; 500 cause to prevent error 414 Request-URI Too Large </span>
<span class="sd">        &lt;verbose&gt; to print out the warning</span>

<span class="sd">        General query structure for IDs: </span>
<span class="sd">           </span>
<span class="sd">        `id: (pub.1120715293 OR pub.1120975084 OR pub.1122068834 OR pub.1120602308)`</span>

<span class="sd">        Final URL looks like this https://app.dimensions.ai/discover/publication?search_text=id%3A+%28pub.1120715293+OR+pub.1120975084+OR+pub.1122068834+OR+pub.1120602308%29</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: this is an experimental and unsupported feature.&quot;</span><span class="p">)</span>

        <span class="c1"># hardcoded</span>
        <span class="n">supported_url_templates</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;publications&#39;</span> <span class="p">:</span> <span class="s2">&quot;https://app.dimensions.ai/discover/publication?search_text=&quot;</span><span class="p">,</span>
            <span class="s1">&#39;grants&#39;</span> <span class="p">:</span> <span class="s2">&quot;https://app.dimensions.ai/discover/grant?search_text=&quot;</span><span class="p">,</span>
            <span class="s1">&#39;patents&#39;</span> <span class="p">:</span> <span class="s2">&quot;https://app.dimensions.ai/discover/patent?search_text=&quot;</span><span class="p">,</span>
            <span class="s1">&#39;clinical_trials&#39;</span> <span class="p">:</span> <span class="s2">&quot;https://app.dimensions.ai/discover/clinical_trial?search_text=&quot;</span><span class="p">,</span>
            <span class="s1">&#39;policy_documents&#39;</span> <span class="p">:</span> <span class="s2">&quot;https://app.dimensions.ai/discover/policy_document?search_text=&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># just return first valid source found in results</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sourcetype</span> <span class="ow">in</span> <span class="n">supported_url_templates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sourcetype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_data_keys</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">sourcetype</span><span class="p">]]</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="s2">&quot; OR &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sourcetype</span> <span class="o">==</span> <span class="s2">&quot;grants&quot;</span><span class="p">:</span>
                        <span class="n">q</span> <span class="o">=</span>  <span class="s2">&quot;grant_id: (&quot;</span> <span class="o">+</span> <span class="n">q</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">q</span> <span class="o">=</span>  <span class="s2">&quot;id: (&quot;</span> <span class="o">+</span> <span class="n">q</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                    <span class="n">q</span> <span class="o">=</span>  <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">supported_url_templates</span><span class="p">[</span><span class="n">sourcetype</span><span class="p">]</span> <span class="o">+</span> <span class="n">q</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;DslDataset records do not contain a valid ID field.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;dimcli.DslDataset object #</span><span class="si">%s</span><span class="s2">. Errors: </span><span class="si">%d</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&lt;dimcli.DslDataset object #</span><span class="si">%s</span><span class="s2">. Records: </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_total</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># non-search queries</span>
                <span class="k">return</span> <span class="s2">&quot;&lt;dimcli.DslDataset object #</span><span class="si">%s</span><span class="s2">. Dict keys: </span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">f</span><span class="s2">&quot;&#39;</span><span class="si">{x}</span><span class="s2">&#39;&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">]))</span></div>





<span class="c1"># 2019-12-17: for backward compatibility</span>
<span class="c1"># remove once all notebooks code has been updated </span>
<span class="n">Result</span> <span class="o">=</span> <span class="n">DslDataset</span>
<span class="n">Dataset</span> <span class="o">=</span> <span class="n">DslDataset</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Digital Science

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>